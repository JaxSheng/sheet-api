<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆå³¶ç”œé» Google Sheets è¨‚å–®è¼¸å…¥</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f7f7f7;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    #orderIdDisplay {
      font-size: 1.2em;
      color: #007bff;
    }
    .form-control {
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
    }
    .form-group {
      margin-bottom: 0.5rem;
    }
    label {
      font-size: 0.9rem;
    }
      .logo-img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    margin-right: 12px;
  }
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingMessage" class="text-center text-warning">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div class="d-flex justify-content-end mb-3">
      <button type="button" class="btn btn-warning" onclick="clearForm()">æ¸…ç©ºè¡¨å–®</button>
    </div>
    <div class="d-flex align-items-center justify-content-center mb-4">
      <img src="./fakemoon.png" alt="æœˆå³¶ç”œé» Logo" class="logo-img">
      <h2 class="mb-0">æœˆå³¶ç”œé» Google Sheets è¨‚å–®è¼¸å…¥</h2>
    </div>
    <form id="orderForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="paymentStatus">ä»˜æ¬¾ç‹€æ…‹ï¼š</label>
            <select id="paymentStatus" class="form-control" ></select>
          </div>
          <div class="form-group">
            <label for="source">ä¾†æºï¼š</label>
            <input list="sourceOptions" id="source" class="form-control" >
            <datalist id="sourceOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="pickupDate">*å–è²¨æ—¥æœŸï¼š</label>
            <input type="date" id="pickupDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="recipient">*å§“åï¼š</label>
            <input type="text" id="recipient" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="phone">*é›»è©±ï¼š</label>
            <input type="text" id="phone" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="registrant">è¯çµ¡çª—å£(ç™»è¨˜è€…)ï¼š</label>
            <select id="registrant" class="form-control" required></select>
          </div>
          <div class="form-group">
            <label for="notes">é™„è¨»ï¼š</label>
            <textarea id="notes" class="form-control"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="cakeFlavor">*å“é …ï¼š</label>
            <input list="cakeFlavorOptions" id="cakeFlavor" class="form-control" required>
            <datalist id="cakeFlavorOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="size">è¦æ ¼ï¼š</label>
            <input list="sizeOptions" id="size" class="form-control">
            <datalist id="sizeOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="quantity">*æ•¸é‡ï¼š</label>
            <input type="number" id="quantity" class="form-control" required value="1" min="1" >
          </div>
          <div class="form-group">
            <label for="candles">è Ÿç‡­ï¼š</label>
            <input list="candlesOptions" id="candles" class="form-control" >
            <datalist id="candlesOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="discount">*æŠ˜æ‰£ï¼š</label>
            <input type="number" id="discount" class="form-control" step="0.05" value="1" min="0">
            <datalist id="discountOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="price">åƒ¹æ ¼ï¼š</label>
            <input type="number" id="price" class="form-control" disabled>
          </div>
          <div class="form-group">
            <label for="pickupTime">*æ–¹å¼ï¼æ™‚æ®µï¼š</label>
            <select id="pickupTime" class="form-control" required></select>
            <div id="deliveryWarning" class="text-danger small mt-1" style="display:none;"></div>
          </div>
          <div id="deliverySection" class="border rounded p-2 mt-2" style="display:none;">
            <div class="form-group mb-2">
              <label for="shipName">æ”¶ä»¶äººå§“åï¼š</label>
              <input type="text" id="shipName" class="form-control">
            </div>
            <div class="form-group mb-2">
              <label for="shipPhone">æ”¶ä»¶äººé›»è©±ï¼š</label>
              <input type="text" id="shipPhone" class="form-control">
            </div>
            <div class="form-group mb-0">
              <label for="shipAddress">å®…é…åœ°å€ï¼š</label>
              <textarea id="shipAddress" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <button type="submit" class="btn btn-primary">æ–°å¢è¨‚å–®</button>
      </div>
    </form>
    <div id="responseMessage" class="mt-3 text-center text-success"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  let cakeData = [];

  function loadCakeData() {
    const url = "https://script.google.com/macros/s/AKfycbzyd9UQMJ8UYKvm_gqSxuxJRILAYmqFdd-SSYJscXojYRg-XLcbcna6qJWuKQ0Te8Lmaw/exec";
    document.getElementById("loadingMessage").style.display = "";
    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error("ä¼ºæœå™¨å›å‚³éŒ¯èª¤ï¼š" + response.status);
        return response.json();
      })
      .then(data => {
        if (!data || !data.cakes || !data.options) throw new Error("ç„¡æ³•å–å¾—æ­£ç¢ºçš„æ•¸æ“šçµæ§‹");
        cakeData = data.cakes;

        const flavorSet = [...new Set(cakeData.map(item => item["å“é …åç¨±"]).filter(Boolean))];
        populateDatalist("cakeFlavorOptions", "cakeFlavor", flavorSet);

        const options = data.options;
        populateSelect("paymentStatus", options["ä»˜æ¬¾ç‹€æ…‹"]);
        populateDatalist("sourceOptions", "source", options["ä¾†æº"]);
        populateDatalist("candlesOptions", "candles", options["è Ÿç‡­"]);
        populateSelect("pickupTime", options["æ–¹å¼/æ™‚æ®µ"]);
        populateSelect("registrant", options["è¯çµ¡çª—å£"]);
        populateDatalist("discountOptions", "discount", options["æŠ˜æ‰£"]);

        console.log("âœ… è³‡æ–™æˆåŠŸè¼‰å…¥");
        document.getElementById("responseMessage").innerText = "âœ… è³‡æ–™æˆåŠŸè¼‰å…¥";
        document.getElementById("loadingMessage").style.display = "none";

        // è¼‰å…¥å®Œæˆåšä¸€æ¬¡ç‹€æ…‹åŒæ­¥
        toggleDeliveryFields();
        checkDeliveryDateRules(false);
      })
      .catch(err => {
        console.error("âŒ è¼‰å…¥å¤±æ•—ï¼š", err);
        document.getElementById("responseMessage").innerText = "âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦";
        document.getElementById("loadingMessage").style.display = "none";
      });
  }

  function populateDatalist(datalistId, inputId, options) {
    const datalist = document.getElementById(datalistId);
    if (!datalist || !Array.isArray(options)) return;

    datalist.innerHTML = "";
    const blankOption = document.createElement("option");
    blankOption.value = "";
    datalist.appendChild(blankOption);

    options.forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      datalist.appendChild(opt);
    });
  }

  function populateSelect(selectId, options, defaultValue = "") {
    const select = document.getElementById(selectId);
    if (!select || !Array.isArray(options)) {
      console.error("âŒ é¸å–®ç„¡æ³•æ­£ç¢ºè¼‰å…¥ï¼š" + selectId);
      return;
    }
    select.innerHTML = "";
    const blankOption = document.createElement("option");
    blankOption.value = "";
    blankOption.textContent = "";
    select.appendChild(blankOption);
    options.forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      opt.textContent = option;
      select.appendChild(opt);
    });
    select.value = defaultValue;
  }

  function autoFillSpecOptions() {
    const selectedFlavor = document.getElementById("cakeFlavor").value.trim();
    const matchedSpecs = cakeData
      .filter(item => item["å“é …åç¨±"] === selectedFlavor)
      .map(item => item["è¦æ ¼"]);
    const uniqueSpecs = [...new Set(matchedSpecs)];
    populateDatalist("sizeOptions", "size", uniqueSpecs);
    updateCalculatedPrice();
  }

  function updateCalculatedPrice() {
    const flavor = document.getElementById("cakeFlavor").value.trim();
    const size = document.getElementById("size").value.trim();
    const quantity = parseFloat(document.getElementById("quantity").value) || 0;
    const discount = parseFloat(document.getElementById("discount").value) || 1;

    const matched = cakeData.find(item =>
      item["å“é …åç¨±"] === flavor && item["è¦æ ¼"] === size
    );

    const unitPrice = matched ? parseFloat(matched["å”®åƒ¹"]) : 0;
    const totalPrice = unitPrice * quantity * discount;

    document.getElementById("price").value = totalPrice ? totalPrice.toFixed(0) : "";
  }

  function toggleDeliveryFields() {
    const method = document.getElementById("pickupTime").value || "";
    const isDelivery = method.includes("å®…é…");

    const section = document.getElementById("deliverySection");
    section.style.display = isDelivery ? "" : "none";

    ["shipName","shipPhone","shipAddress"].forEach(id => {
      const el = document.getElementById(id);
      el.required = isDelivery;
      if (!isDelivery) el.value = "";
    });
  }

  // è‡ªå‹•å»ºç«‹æé†’å€å¡Šï¼ˆè‹¥ HTML æ²’åŠ ï¼‰
  function ensureDeliveryWarningPlaceholder() {
    if (!document.getElementById("deliveryWarning")) {
      const warn = document.createElement("div");
      warn.id = "deliveryWarning";
      warn.className = "text-danger small mt-1";
      warn.style.display = "none";
      const pickupTimeEl = document.getElementById("pickupTime");
      pickupTimeEl.parentElement.appendChild(warn);
    }
  }

  // å®…é…æ—¥æœŸè¦å‰‡ï¼šé€±æ—¥ç¦æ­¢ã€é€±ä¸€æé†’
  function checkDeliveryDateRules(showAlert) {
    ensureDeliveryWarningPlaceholder();
    const method = document.getElementById("pickupTime").value || "";
    const isDelivery = method.includes("å®…é…");
    const dateStr = document.getElementById("pickupDate").value; // YYYY-MM-DD
    const warnEl = document.getElementById("deliveryWarning");

    // æ¸…æé†’
    warnEl.style.display = "none";
    warnEl.textContent = "";

    if (!isDelivery || !dateStr) {
      return { valid: true, isDelivery, monday: false, sunday: false };
    }

    const d = new Date(dateStr + "T00:00:00");
    const dow = d.getDay(); // 0=Sun,1=Mon,...6=Sat

    if (dow === 0) { // æ˜ŸæœŸæ—¥
      const msg = "â›” å–è²¨æ—¥ç‚ºæ˜ŸæœŸæ—¥ï¼Œç„¡æ³•é¸æ“‡å®…é…ã€‚";
      warnEl.textContent = msg;
      warnEl.style.display = "block";
      if (showAlert) alert(msg);
      return { valid: false, isDelivery, monday: false, sunday: true };
    }

    if (dow === 1) { // æ˜ŸæœŸä¸€
      const msg = "âš ï¸ å–è²¨æ—¥ç‚ºæ˜ŸæœŸä¸€ï¼šè«‹å…ˆå’Œå®¢äººç¢ºèªè›‹ç³•æœƒå¤šæ”¾ä¸€å¤©ï¼ˆé€±æ—¥ä¸é…é€ï¼‰ã€‚";
      warnEl.textContent = msg;
      warnEl.style.display = "block";
      return { valid: true, isDelivery, monday: true, sunday: false };
    }

    return { valid: true, isDelivery, monday: false, sunday: false };
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("loadingMessage").style.display = "";
    loadCakeData();

    document.getElementById("cakeFlavor").addEventListener("change", autoFillSpecOptions);
    document.getElementById("size").addEventListener("change", updateCalculatedPrice);
    document.getElementById("quantity").addEventListener("input", updateCalculatedPrice);
    document.getElementById("discount").addEventListener("input", updateCalculatedPrice);

    document.getElementById("pickupTime").addEventListener("change", () => {
      toggleDeliveryFields();
      checkDeliveryDateRules(false);
    });
    document.getElementById("pickupDate").addEventListener("change", () => {
      checkDeliveryDateRules(false);
    });

    // åˆå§‹åŒæ­¥ï¼ˆé¿å…é è¨­å€¼æ˜¯å®…é…ä½†æ²’é¡¯ç¤ºï¼‰
    ensureDeliveryWarningPlaceholder();
    setTimeout(() => {
      toggleDeliveryFields();
      checkDeliveryDateRules(false);
    }, 0);

    // âœ… è¡¨å–®é€å‡º
    document.getElementById("orderForm").addEventListener("submit", function (event) {
      event.preventDefault();

      // å…ˆæª¢æŸ¥å®…é…æ—¥æœŸè¦å‰‡
      const rule = checkDeliveryDateRules(true);
      if (!rule.valid) {
        document.getElementById("responseMessage").innerText = "ğŸš« æ˜ŸæœŸæ—¥ä¸æä¾›å®…é…ï¼Œè«‹æ”¹é¸å–è²¨æ–¹å¼æˆ–æ—¥æœŸ";
        return;
      }

      const pickupDate = document.getElementById("pickupDate").value;
      const cakeFlavor = document.getElementById("cakeFlavor").value;
      const method = document.getElementById("pickupTime").value || "";
      const isDelivery = method.includes("å®…é…");

      // å®…é…ï¼šé è¨­æ”¶ä»¶äºº/é›»è©±
      if (isDelivery) {
        const recipient = document.getElementById("recipient").value.trim();
        const phone = document.getElementById("phone").value.trim();
        if (!document.getElementById("shipName").value.trim()) {
          document.getElementById("shipName").value = recipient;
        }
        if (!document.getElementById("shipPhone").value.trim()) {
          document.getElementById("shipPhone").value = phone;
        }
      }

      // ç¢ºèªè¨Šæ¯
      let confirmMessage = `å–è²¨æ—¥æœŸï¼š${pickupDate}\nè›‹ç³•å£å‘³ï¼š${cakeFlavor}\næ–¹å¼ï¼æ™‚æ®µï¼š${method}`;
      if (isDelivery) {
        confirmMessage += `\n\nã€é…é€è³‡è¨Šã€‘\næ”¶ä»¶äººï¼š${document.getElementById("shipName").value}\né›»è©±ï¼š${document.getElementById("shipPhone").value}\nåœ°å€ï¼š${document.getElementById("shipAddress").value}`;
      }
      confirmMessage += `\n\nè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢ºä¸¦é€å‡ºï¼Ÿ`;
      if (rule.isDelivery && rule.monday) {
        confirmMessage = "âš ï¸ å®…é…ä¸”å–è²¨æ—¥ç‚ºæ˜ŸæœŸä¸€ï¼šè«‹å…ˆèˆ‡å®¢äººç¢ºèªè›‹ç³•æœƒå¤šæ”¾ä¸€å¤©ã€‚\n\n" + confirmMessage;
      }

      if (!confirm(confirmMessage)) {
        document.getElementById("responseMessage").innerText = "ğŸš« è¨‚å–®å·²å–æ¶ˆ";
        return;
      }

      const formData = new URLSearchParams();
      formData.append("paymentStatus", document.getElementById("paymentStatus").value);
      formData.append("source", document.getElementById("source").value);
      formData.append("pickupDate", document.getElementById("pickupDate").value);
      formData.append("recipient", document.getElementById("recipient").value);
      formData.append("phone", document.getElementById("phone").value);
      formData.append("cakeFlavor", document.getElementById("cakeFlavor").value);
      formData.append("size", document.getElementById("size").value);
      formData.append("quantity", document.getElementById("quantity").value);
      formData.append("candles", document.getElementById("candles").value);
      formData.append("discount", document.getElementById("discount").value);
      formData.append("pickupTime", document.getElementById("pickupTime").value);
      formData.append("price", document.getElementById("price").value);
      formData.append("registrant", document.getElementById("registrant").value);
      formData.append("notes", document.getElementById("notes").value);
      formData.append("shipName", document.getElementById("shipName").value);
      formData.append("shipPhone", document.getElementById("shipPhone").value);
      formData.append("shipAddress", document.getElementById("shipAddress").value);

      // æ³¨æ„ï¼šé€™å€‹ URL æ˜¯ä½ çš„ doPost ç«¯é»ï¼Œèˆ‡ doGet å¯ä¸åŒ
      fetch("https://script.google.com/macros/s/AKfycbwz-IKKRLSVEYnowHP1fG_dQ6RUILXhJY9Hxi_fPf7v4BlAYSx5maqc9SoYiBqNBQKjhg/exec", {
        method: "POST",
        body: formData.toString(),
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        mode: "no-cors"
      })
      .then(() => {
        console.log("âœ… è³‡æ–™å·²é€å‡ºï¼ˆno-cors æ¨¡å¼ï¼‰");
        document.getElementById("responseMessage").innerText = "âœ… è¨‚å–®å·²é€å‡º";
      })
      .catch(err => {
        console.error("âŒ ç™¼é€å¤±æ•—ï¼š", err);
        document.getElementById("responseMessage").innerText = "âŒ ç„¡æ³•é€å‡ºè¨‚å–®ï¼Œè«‹ç¨å¾Œé‡è©¦";
      });
    });
  });

  function clearForm() {
    document.getElementById("orderForm").reset();
    document.getElementById("responseMessage").innerText = "";
    toggleDeliveryFields();
    checkDeliveryDateRules(false);
  }
</script>
</body>
</html>
