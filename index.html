<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>月島甜點 Google Sheets 訂單輸入</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f7f7f7;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    #orderIdDisplay {
      font-size: 1.2em;
      color: #007bff;
    }
    .form-control {
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
    }
    .form-group {
      margin-bottom: 0.5rem;
    }
    label {
      font-size: 0.9rem;
    }
      .logo-img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    margin-right: 12px;
  }
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingMessage" class="text-center text-warning">資料載入中，請稍候...</div>
    <div class="d-flex justify-content-end mb-3">
      <button type="button" class="btn btn-warning" onclick="clearForm()">清空表單</button>
    </div>
    <div class="d-flex align-items-center justify-content-center mb-4">
      <img src="./fakemoon.png" alt="月島甜點 Logo" class="logo-img">
      <h2 class="mb-0">月島甜點 Google Sheets 訂單輸入</h2>
    </div>
    <form id="orderForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="paymentStatus">付款狀態：</label>
            <select id="paymentStatus" class="form-control" ></select>
          </div>
          <div class="form-group">
            <label for="source">來源：</label>
            <input list="sourceOptions" id="source" class="form-control" >
            <datalist id="sourceOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="pickupDate">*取貨日期：</label>
            <input type="date" id="pickupDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="recipient">*姓名：</label>
            <input type="text" id="recipient" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="phone">*電話：</label>
            <input type="text" id="phone" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="registrant">聯絡窗口(登記者)：</label>
            <select id="registrant" class="form-control" required></select>
          </div>
          <div class="form-group">
            <label for="notes">附註：</label>
            <textarea id="notes" class="form-control"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="cakeFlavor">*品項：</label>
            <input list="cakeFlavorOptions" id="cakeFlavor" class="form-control" required>
            <datalist id="cakeFlavorOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="size">規格：</label>
            <input list="sizeOptions" id="size" class="form-control">
            <datalist id="sizeOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="quantity">*數量：</label>
            <input type="number" id="quantity" class="form-control" required value="1" min="1" >
          </div>
          <div class="form-group">
            <label for="candles">蠟燭：</label>
            <input list="candlesOptions" id="candles" class="form-control" >
            <datalist id="candlesOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="discount">*折扣：</label>
            <input type="number" id="discount" class="form-control" step="0.05" value="1" min="0">
            <datalist id="discountOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="price">價格：</label>
            <input type="number" id="price" class="form-control" disabled>
          </div>
          <div class="form-group">
            <label for="pickupTime">*方式／時段：</label>
            <select id="pickupTime" class="form-control" required></select>
            <div id="deliveryWarning" class="text-danger small mt-1" style="display:none;"></div>
          </div>
          <div id="deliverySection" class="border rounded p-2 mt-2" style="display:none;">
            <div class="form-group mb-2">
              <label for="shipName">收件人姓名：</label>
              <input type="text" id="shipName" class="form-control">
            </div>
            <div class="form-group mb-2">
              <label for="shipPhone">收件人電話：</label>
              <input type="text" id="shipPhone" class="form-control">
            </div>
            <div class="form-group mb-0">
              <label for="shipAddress">宅配地址：</label>
              <textarea id="shipAddress" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <button type="submit" class="btn btn-primary">新增訂單</button>
      </div>
    </form>
    <div id="responseMessage" class="mt-3 text-center text-success"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  let cakeData = [];

  function loadCakeData() {
    const url = "https://script.google.com/macros/s/AKfycbzyd9UQMJ8UYKvm_gqSxuxJRILAYmqFdd-SSYJscXojYRg-XLcbcna6qJWuKQ0Te8Lmaw/exec";
    document.getElementById("loadingMessage").style.display = "";
    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error("伺服器回傳錯誤：" + response.status);
        return response.json();
      })
      .then(data => {
        if (!data || !data.cakes || !data.options) throw new Error("無法取得正確的數據結構");
        cakeData = data.cakes;

        const flavorSet = [...new Set(cakeData.map(item => item["品項名稱"]).filter(Boolean))];
        populateDatalist("cakeFlavorOptions", "cakeFlavor", flavorSet);

        const options = data.options;
        populateSelect("paymentStatus", options["付款狀態"]);
        populateDatalist("sourceOptions", "source", options["來源"]);
        populateDatalist("candlesOptions", "candles", options["蠟燭"]);
        populateSelect("pickupTime", options["方式/時段"]);
        populateSelect("registrant", options["聯絡窗口"]);
        populateDatalist("discountOptions", "discount", options["折扣"]);

        console.log("✅ 資料成功載入");
        document.getElementById("responseMessage").innerText = "✅ 資料成功載入";
        document.getElementById("loadingMessage").style.display = "none";

        // 載入完成做一次狀態同步
        toggleDeliveryFields();
        checkDeliveryDateRules(false);
      })
      .catch(err => {
        console.error("❌ 載入失敗：", err);
        document.getElementById("responseMessage").innerText = "❌ 資料載入失敗，請重試";
        document.getElementById("loadingMessage").style.display = "none";
      });
  }

  function populateDatalist(datalistId, inputId, options) {
    const datalist = document.getElementById(datalistId);
    if (!datalist || !Array.isArray(options)) return;

    datalist.innerHTML = "";
    const blankOption = document.createElement("option");
    blankOption.value = "";
    datalist.appendChild(blankOption);

    options.forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      datalist.appendChild(opt);
    });
  }

  function populateSelect(selectId, options, defaultValue = "") {
    const select = document.getElementById(selectId);
    if (!select || !Array.isArray(options)) {
      console.error("❌ 選單無法正確載入：" + selectId);
      return;
    }
    select.innerHTML = "";
    const blankOption = document.createElement("option");
    blankOption.value = "";
    blankOption.textContent = "";
    select.appendChild(blankOption);
    options.forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      opt.textContent = option;
      select.appendChild(opt);
    });
    select.value = defaultValue;
  }

  function autoFillSpecOptions() {
    const selectedFlavor = document.getElementById("cakeFlavor").value.trim();
    const matchedSpecs = cakeData
      .filter(item => item["品項名稱"] === selectedFlavor)
      .map(item => item["規格"]);
    const uniqueSpecs = [...new Set(matchedSpecs)];
    populateDatalist("sizeOptions", "size", uniqueSpecs);
    updateCalculatedPrice();
  }

  function updateCalculatedPrice() {
    const flavor = document.getElementById("cakeFlavor").value.trim();
    const size = document.getElementById("size").value.trim();
    const quantity = parseFloat(document.getElementById("quantity").value) || 0;
    const discount = parseFloat(document.getElementById("discount").value) || 1;

    const matched = cakeData.find(item =>
      item["品項名稱"] === flavor && item["規格"] === size
    );

    const unitPrice = matched ? parseFloat(matched["售價"]) : 0;
    const totalPrice = unitPrice * quantity * discount;

    document.getElementById("price").value = totalPrice ? totalPrice.toFixed(0) : "";
  }

  function toggleDeliveryFields() {
    const method = document.getElementById("pickupTime").value || "";
    const isDelivery = method.includes("宅配");

    const section = document.getElementById("deliverySection");
    section.style.display = isDelivery ? "" : "none";

    ["shipName","shipPhone","shipAddress"].forEach(id => {
      const el = document.getElementById(id);
      el.required = isDelivery;
      if (!isDelivery) el.value = "";
    });
  }

  // 自動建立提醒區塊（若 HTML 沒加）
  function ensureDeliveryWarningPlaceholder() {
    if (!document.getElementById("deliveryWarning")) {
      const warn = document.createElement("div");
      warn.id = "deliveryWarning";
      warn.className = "text-danger small mt-1";
      warn.style.display = "none";
      const pickupTimeEl = document.getElementById("pickupTime");
      pickupTimeEl.parentElement.appendChild(warn);
    }
  }

  // 宅配日期規則：週日禁止、週一提醒
  function checkDeliveryDateRules(showAlert) {
    ensureDeliveryWarningPlaceholder();
    const method = document.getElementById("pickupTime").value || "";
    const isDelivery = method.includes("宅配");
    const dateStr = document.getElementById("pickupDate").value; // YYYY-MM-DD
    const warnEl = document.getElementById("deliveryWarning");

    // 清提醒
    warnEl.style.display = "none";
    warnEl.textContent = "";

    if (!isDelivery || !dateStr) {
      return { valid: true, isDelivery, monday: false, sunday: false };
    }

    const d = new Date(dateStr + "T00:00:00");
    const dow = d.getDay(); // 0=Sun,1=Mon,...6=Sat

    if (dow === 0) { // 星期日
      const msg = "⛔ 取貨日為星期日，無法選擇宅配。";
      warnEl.textContent = msg;
      warnEl.style.display = "block";
      if (showAlert) alert(msg);
      return { valid: false, isDelivery, monday: false, sunday: true };
    }

    if (dow === 1) { // 星期一
      const msg = "⚠️ 取貨日為星期一：請先和客人確認蛋糕會多放一天（週日不配送）。";
      warnEl.textContent = msg;
      warnEl.style.display = "block";
      return { valid: true, isDelivery, monday: true, sunday: false };
    }

    return { valid: true, isDelivery, monday: false, sunday: false };
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("loadingMessage").style.display = "";
    loadCakeData();

    document.getElementById("cakeFlavor").addEventListener("change", autoFillSpecOptions);
    document.getElementById("size").addEventListener("change", updateCalculatedPrice);
    document.getElementById("quantity").addEventListener("input", updateCalculatedPrice);
    document.getElementById("discount").addEventListener("input", updateCalculatedPrice);

    document.getElementById("pickupTime").addEventListener("change", () => {
      toggleDeliveryFields();
      checkDeliveryDateRules(false);
    });
    document.getElementById("pickupDate").addEventListener("change", () => {
      checkDeliveryDateRules(false);
    });

    // 初始同步（避免預設值是宅配但沒顯示）
    ensureDeliveryWarningPlaceholder();
    setTimeout(() => {
      toggleDeliveryFields();
      checkDeliveryDateRules(false);
    }, 0);

    // ✅ 表單送出
    document.getElementById("orderForm").addEventListener("submit", function (event) {
      event.preventDefault();

      // 先檢查宅配日期規則
      const rule = checkDeliveryDateRules(true);
      if (!rule.valid) {
        document.getElementById("responseMessage").innerText = "🚫 星期日不提供宅配，請改選取貨方式或日期";
        return;
      }

      const pickupDate = document.getElementById("pickupDate").value;
      const cakeFlavor = document.getElementById("cakeFlavor").value;
      const method = document.getElementById("pickupTime").value || "";
      const isDelivery = method.includes("宅配");

      // 宅配：預設收件人/電話
      if (isDelivery) {
        const recipient = document.getElementById("recipient").value.trim();
        const phone = document.getElementById("phone").value.trim();
        if (!document.getElementById("shipName").value.trim()) {
          document.getElementById("shipName").value = recipient;
        }
        if (!document.getElementById("shipPhone").value.trim()) {
          document.getElementById("shipPhone").value = phone;
        }
      }

      // 確認訊息
      let confirmMessage = `取貨日期：${pickupDate}\n蛋糕口味：${cakeFlavor}\n方式／時段：${method}`;
      if (isDelivery) {
        confirmMessage += `\n\n【配送資訊】\n收件人：${document.getElementById("shipName").value}\n電話：${document.getElementById("shipPhone").value}\n地址：${document.getElementById("shipAddress").value}`;
      }
      confirmMessage += `\n\n請確認資料是否正確並送出？`;
      if (rule.isDelivery && rule.monday) {
        confirmMessage = "⚠️ 宅配且取貨日為星期一：請先與客人確認蛋糕會多放一天。\n\n" + confirmMessage;
      }

      if (!confirm(confirmMessage)) {
        document.getElementById("responseMessage").innerText = "🚫 訂單已取消";
        return;
      }

      const formData = new URLSearchParams();
      formData.append("paymentStatus", document.getElementById("paymentStatus").value);
      formData.append("source", document.getElementById("source").value);
      formData.append("pickupDate", document.getElementById("pickupDate").value);
      formData.append("recipient", document.getElementById("recipient").value);
      formData.append("phone", document.getElementById("phone").value);
      formData.append("cakeFlavor", document.getElementById("cakeFlavor").value);
      formData.append("size", document.getElementById("size").value);
      formData.append("quantity", document.getElementById("quantity").value);
      formData.append("candles", document.getElementById("candles").value);
      formData.append("discount", document.getElementById("discount").value);
      formData.append("pickupTime", document.getElementById("pickupTime").value);
      formData.append("price", document.getElementById("price").value);
      formData.append("registrant", document.getElementById("registrant").value);
      formData.append("notes", document.getElementById("notes").value);
      formData.append("shipName", document.getElementById("shipName").value);
      formData.append("shipPhone", document.getElementById("shipPhone").value);
      formData.append("shipAddress", document.getElementById("shipAddress").value);

      // 注意：這個 URL 是你的 doPost 端點，與 doGet 可不同
      fetch("https://script.google.com/macros/s/AKfycbwz-IKKRLSVEYnowHP1fG_dQ6RUILXhJY9Hxi_fPf7v4BlAYSx5maqc9SoYiBqNBQKjhg/exec", {
        method: "POST",
        body: formData.toString(),
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        mode: "no-cors"
      })
      .then(() => {
        console.log("✅ 資料已送出（no-cors 模式）");
        document.getElementById("responseMessage").innerText = "✅ 訂單已送出";
      })
      .catch(err => {
        console.error("❌ 發送失敗：", err);
        document.getElementById("responseMessage").innerText = "❌ 無法送出訂單，請稍後重試";
      });
    });
  });

  function clearForm() {
    document.getElementById("orderForm").reset();
    document.getElementById("responseMessage").innerText = "";
    toggleDeliveryFields();
    checkDeliveryDateRules(false);
  }
</script>
</body>
</html>
