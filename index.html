<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆå³¶ç”œé» Google Sheets è¨‚å–®è¼¸å…¥</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f7f7f7;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    #orderIdDisplay {
      font-size: 1.2em;
      color: #007bff;
    }
    .form-control {
      font-size: 0.9rem;
      padding: 0.25rem 0.5rem;
    }
    .form-group {
      margin-bottom: 0.5rem;
    }
    label {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingMessage" class="text-center text-warning">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div class="d-flex justify-content-end mb-3">
      <button type="button" class="btn btn-warning" onclick="clearForm()">æ¸…ç©ºè¡¨å–®</button>
    </div>
    <h2 class="text-center mb-4">æœˆå³¶ç”œé» Google Sheets è¨‚å–®è¼¸å…¥</h2>
    <form id="orderForm">
      <div class="row">
        <div class="col-md-6">
          <div class="form-group">
            <label for="paymentStatus">ä»˜æ¬¾ç‹€æ…‹ï¼š</label>
            <select id="paymentStatus" class="form-control" ></select>
          </div>
          <div class="form-group">
            <label for="source">ä¾†æºï¼š</label>
            <input list="sourceOptions" id="source" class="form-control" required>
            <datalist id="sourceOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="pickupDate">*å–è²¨æ—¥æœŸï¼š</label>
            <input type="date" id="pickupDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="recipient">*å§“åï¼š</label>
            <input type="text" id="recipient" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="phone">*é›»è©±ï¼š</label>
            <input type="text" id="phone" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="registrant">è¯çµ¡çª—å£(ç™»è¨˜è€…)ï¼š</label>
            <select id="registrant" class="form-control" required></select>
          </div>
          <div class="form-group">
            <label for="notes">é™„è¨»ï¼š</label>
            <textarea id="notes" class="form-control"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="cakeFlavor">*å“é …ï¼š</label>
            <input list="cakeFlavorOptions" id="cakeFlavor" class="form-control" required>
            <datalist id="cakeFlavorOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="size">è¦æ ¼ï¼š</label>
            <select id="size" class="form-control" ></select>
          </div>
          <div class="form-group">
            <label for="quantity">*æ•¸é‡ï¼š</label>
            <input type="number" id="quantity" class="form-control" required value="1" min="1" >
          </div>
          <div class="form-group">
            <label for="candles">è Ÿç‡­ï¼š</label>
            <input list="candlesOptions" id="candles" class="form-control" >
            <datalist id="candlesOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="discount">*æŠ˜æ‰£ï¼š</label>
            <input type="number" id="discount" class="form-control" step="0.05" value="1" min="0">
            <datalist id="discountOptions"></datalist>
          </div>
          <div class="form-group">
            <label for="price">åƒ¹æ ¼ï¼š</label>
            <input type="number" id="price" class="form-control" disabled>
          </div>
          <div class="form-group">
            <label for="pickupTime">*æ–¹å¼ï¼æ™‚æ®µï¼š</label>
            <select id="pickupTime" class="form-control" required></select>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-3">
        <button type="submit" class="btn btn-primary">æ–°å¢è¨‚å–®</button>
      </div>
    </form>
    <div id="responseMessage" class="mt-3 text-center text-success"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let cakeData = [];

    function loadCakeData() {
      const url = "https://script.google.com/macros/s/AKfycbzyd9UQMJ8UYKvm_gqSxuxJRILAYmqFdd-SSYJscXojYRg-XLcbcna6qJWuKQ0Te8Lmaw/exec";
      document.getElementById("loadingMessage").style.display = "";
      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error("ä¼ºæœå™¨å›å‚³éŒ¯èª¤ï¼š" + response.status);
          }
          return response.json();
        })
        .then(data => {
          if (!data || !data.cakes || !data.options) {
            throw new Error("ç„¡æ³•å–å¾—æ­£ç¢ºçš„æ•¸æ“šçµæ§‹");
          }
          cakeData = data.cakes;
          const flavorSet = [...new Set(cakeData.map(item => item["å“é …åç¨±"]).filter(Boolean))];
          populateDatalist("cakeFlavorOptions", "cakeFlavor", flavorSet);
          const options = data.options;
          populateSelect("paymentStatus", options["ä»˜æ¬¾ç‹€æ…‹"]);
          populateDatalist("sourceOptions", "source", options["ä¾†æº"]);
          populateDatalist("candlesOptions", "candles", options["è Ÿç‡­"]);
          populateSelect("pickupTime", options["æ–¹å¼/æ™‚æ®µ"]);
          populateSelect("registrant", options["è¯çµ¡çª—å£"]);
          populateDatalist("discountOptions", "discount", options["æŠ˜æ‰£"]);
          console.log("âœ… è³‡æ–™æˆåŠŸè¼‰å…¥");
          document.getElementById("responseMessage").innerText = "âœ… è³‡æ–™æˆåŠŸè¼‰å…¥";
          document.getElementById("loadingMessage").style.display = "none";
        })
        .catch(err => {
          console.error("âŒ è¼‰å…¥å¤±æ•—ï¼š", err);
          document.getElementById("responseMessage").innerText = "âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦";
          document.getElementById("loadingMessage").style.display = "none";
        });
    }

    function populateDatalist(datalistId, inputId, options) {
      const datalist = document.getElementById(datalistId);
      const input = document.getElementById(inputId);
      if (!datalist || !Array.isArray(options)) return;
    
      datalist.innerHTML = "";
    
      // â¤ åŠ å…¥ä¸€å€‹ç©ºç™½é¸é …
      const blankOption = document.createElement("option");
      blankOption.value = "";
      datalist.appendChild(blankOption);
    
      options.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        datalist.appendChild(opt);
      });
    }

    function populateSelect(selectId, options, defaultValue = "") {
      const select = document.getElementById(selectId);
      if (!select || !Array.isArray(options)) {
        console.error("âŒ é¸å–®ç„¡æ³•æ­£ç¢ºè¼‰å…¥ï¼š" + selectId);
        return;
      }
      select.innerHTML = "";
      const blankOption = document.createElement("option");
      blankOption.value = "";
      blankOption.textContent = "";
      select.appendChild(blankOption);
      options.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      });
      select.value = defaultValue;
    }

    function autoFillSpecOptions() {
      const selectedFlavor = document.getElementById("cakeFlavor").value.trim();
      const matchedSpecs = cakeData
        .filter(item => item["å“é …åç¨±"] === selectedFlavor)
        .map(item => item["è¦æ ¼"]);
      const uniqueSpecs = [...new Set(matchedSpecs)];
      populateSelect("size", uniqueSpecs);
      updateCalculatedPrice();
    }

    function updateCalculatedPrice() {
      const flavor = document.getElementById("cakeFlavor").value.trim();
      const size = document.getElementById("size").value.trim();
      const quantity = parseFloat(document.getElementById("quantity").value) || 0;
      const discount = parseFloat(document.getElementById("discount").value) || 1;

      const matched = cakeData.find(item =>
        item["å“é …åç¨±"] === flavor && item["è¦æ ¼"] === size
      );

      const unitPrice = matched ? parseFloat(matched["å”®åƒ¹"]) : 0;
      const totalPrice = unitPrice * quantity * discount;

      document.getElementById("price").value = totalPrice ? totalPrice.toFixed(0) : "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // é¡¯ç¤ºè¼‰å…¥ä¸­è¨Šæ¯
      document.getElementById("loadingMessage").style.display = "";
      loadCakeData();
      document.getElementById("cakeFlavor").addEventListener("change", autoFillSpecOptions);
      document.getElementById("size").addEventListener("change", updateCalculatedPrice);
      document.getElementById("quantity").addEventListener("input", updateCalculatedPrice);
      document.getElementById("discount").addEventListener("input", updateCalculatedPrice);

      // âœ… è¡¨å–®é€å‡ºé‚è¼¯æ”¾é€™è£¡ï¼
      document.getElementById("orderForm").addEventListener("submit", function (event) {
        event.preventDefault(); // é˜²æ­¢é è¨­é€å‡º
        // è·³å‡ºç¢ºèªé€šçŸ¥
        const pickupDate = document.getElementById("pickupDate").value;
        const cakeFlavor = document.getElementById("cakeFlavor").value;
        const confirmMessage = `å–è²¨æ—¥æœŸï¼š${pickupDate}\nè›‹ç³•å£å‘³ï¼š${cakeFlavor}\n\nè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢ºä¸¦é€å‡ºï¼Ÿ`;

        if (!confirm(confirmMessage)) {
          document.getElementById("responseMessage").innerText = "ğŸš« è¨‚å–®å·²å–æ¶ˆ";
          return;
        }

        const formData = new URLSearchParams();
        formData.append("paymentStatus", document.getElementById("paymentStatus").value);
        formData.append("source", document.getElementById("source").value);
        formData.append("pickupDate", document.getElementById("pickupDate").value);
        formData.append("recipient", document.getElementById("recipient").value);
        formData.append("phone", document.getElementById("phone").value);
        formData.append("cakeFlavor", document.getElementById("cakeFlavor").value);
        formData.append("size", document.getElementById("size").value);
        formData.append("quantity", document.getElementById("quantity").value);
        formData.append("candles", document.getElementById("candles").value);
        formData.append("discount", document.getElementById("discount").value);
        formData.append("pickupTime", document.getElementById("pickupTime").value);
        formData.append("price", document.getElementById("price").value);
        formData.append("registrant", document.getElementById("registrant").value);
        formData.append("notes", document.getElementById("notes").value);

        fetch("https://script.google.com/macros/s/AKfycbzyd9UQMJ8UYKvm_gqSxuxJRILAYmqFdd-SSYJscXojYRg-XLcbcna6qJWuKQ0Te8Lmaw/exec", {
          method: "POST",
          body: formData.toString(),
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          mode: "no-cors"
        })
        .then(() => {
          // âš ï¸ å› ç‚ºæ˜¯ no-cors æ‰€ä»¥ä¸èƒ½ .json()ï¼Œç›´æ¥è¦–ç‚ºæˆåŠŸ
          console.log("âœ… è³‡æ–™å·²é€å‡ºï¼ˆno-cors æ¨¡å¼ï¼‰");
          document.getElementById("responseMessage").innerText = "âœ… è¨‚å–®å·²é€å‡º";
        })
        .catch(err => {
          console.error("âŒ ç™¼é€å¤±æ•—ï¼š", err);
          document.getElementById("responseMessage").innerText = "âŒ ç„¡æ³•é€å‡ºè¨‚å–®ï¼Œè«‹ç¨å¾Œé‡è©¦";
        });
      });
    });
function clearForm() {
  document.getElementById("orderForm").reset();
  document.getElementById("responseMessage").innerText = "";
}
  </script>
</body>
</html>
